# ë§ˆë¹„ë…¸ê¸° ëª¨ë°”ì¼ ì•…ë³´ ìƒì„± í”„ë¡œê·¸ë¨ ìˆ˜ì • ì™„ë£Œ ë³´ê³ ì„œ

## ğŸ“‹ ë¬¸ì œ ìš”ì•½

### ë°œê²¬ëœ ì£¼ìš” ë¬¸ì œ
1. **í™”ìŒ íƒ€ì´ë° ê¼¬ì„**: í…œí¬ ë³€ê²½ì´ë‚˜ íŠ¹ì • ì¡°ê±´ì—ì„œ í™”ìŒì´ ì œëŒ€ë¡œ ë™ê¸°í™”ë˜ì§€ ì•ŠìŒ
2. **í™”ìŒ ë¶„ë¦¬ ë¶ˆì¼ì¹˜**: ëœë¤í•˜ê²Œ í™”ìŒì´ ë¶„ë¦¬ë˜ì–´ ì•…ê¸° ì—°ì£¼ì í• ë‹¹ì´ ê¹”ë”í•˜ì§€ ì•ŠìŒ
3. **ë©œë¡œë”” ì„ íƒ ì˜¤ë¥˜**: ê°€ì¥ ë†’ì€ ìŒì´ ë©œë¡œë””ë¡œ ì„ íƒë˜ì§€ ì•Šê³  Voice í• ë‹¹ì´ ë¹„ì¼ê´€ì 

## ğŸ” ì›ì¸ ë¶„ì„

### 1. TPB (Ticks Per Beat) ë³€í™˜ ë¬¸ì œ
- **ë¬¸ì œ**: í•˜ë“œì½”ë”©ëœ TPB (384)ì™€ ì‹¤ì œ MIDI íŒŒì¼ì˜ TPB (480) ë¶ˆì¼ì¹˜
- **ì˜í–¥**: 20% íƒ€ì´ë° ì˜¤ì°¨ ë°œìƒ (480 â†’ 384 ë³€í™˜ ì‹œ)
- **ìœ„ì¹˜**: `converter.rs` - `extract_midi_notes` í•¨ìˆ˜

### 2. ë³€í™˜ ìˆœì„œ ì˜¤ë¥˜
```rust
// ìˆ˜ì • ì „ (ì˜ëª»ëœ ìˆœì„œ)
let start_adjusted = (start * TPB) / tpb;
let start_snapped = snap_to_grid(start_adjusted);

// ë¬¸ì œ: ë³€í™˜ ì „ ìŠ¤ëƒ…í•˜ë©´ ì •ë°€ë„ ì†ì‹¤
```

### 3. ë©œë¡œë”” ì„ íƒ ë¡œì§ ê²°í•¨
```rust
// ìˆ˜ì • ì „
// ì´ì „ ë…¸íŠ¸ì™€ ê°€ì¥ ê°€ê¹Œìš´ ìŒë§Œ ê³ ë ¤ â†’ ë‚®ì€ ìŒì´ ë©œë¡œë””ë¡œ ì„ íƒë¨

// ì˜ˆ: Tick 576ì—ì„œ í™”ìŒ [74, 69, 43]
// ì´ì „ ë©œë¡œë””: 71
// ì„ íƒë¨: 69 (71ê³¼ ê°€ì¥ ê°€ê¹Œì›€) âŒ
// ì˜¬ë°”ë¦„: 74 (ê°€ì¥ ë†’ì€ ìŒ) âœ“
```

## âœ… ì ìš©ëœ ìˆ˜ì •ì‚¬í•­

### 1. TPB ë³€í™˜ ë¡œì§ ê°œì„  (`converter.rs` line 152-311)

#### ìˆ˜ì • ë‚´ìš©:
```rust
// TPB ë³€í™˜ ë¹„ìœ¨ ê³„ì‚° (í•œ ë²ˆë§Œ)
let tpb_ratio = TPB as f64 / tpb as f64;

// ì˜¬ë°”ë¥¸ ìˆœì„œ: ë³€í™˜ â†’ ìŠ¤ëƒ…
let start_converted = (start as f64 * tpb_ratio).round() as u32;
let duration_converted = (duration as f64 * tpb_ratio).round() as u32;

let start_snapped = snap_to_grid(start_converted);
let end_converted = start_converted + duration_converted;
let end_snapped = snap_to_grid(end_converted);

let mut duration_snapped = end_snapped.saturating_sub(start_snapped);

// ìµœì†Œ ê¸¸ì´ ë³´ì¥
if duration_snapped < GRID_SIZE {
    duration_snapped = GRID_SIZE;
}
```

#### íš¨ê³¼:
- âœ… íƒ€ì´ë° ì •í™•ë„ í–¥ìƒ
- âœ… ê·¸ë¦¬ë“œ ì •ë ¬ ì¼ê´€ì„± í™•ë³´
- âœ… ìµœì†Œ ê¸¸ì´ ë³´ì¥ìœ¼ë¡œ ê·¹ë‹¨ì  ì§§ì€ ë…¸íŠ¸ ë°©ì§€

### 2. ë©œë¡œë”” ì„ íƒ ì•Œê³ ë¦¬ì¦˜ ê°œì„  (`converter.rs` line 313-417)

#### ìˆ˜ì • ë‚´ìš©:
```rust
// ë©œë¡œë”” ì„ íƒ ê°œì„ : ê°€ì¥ ë†’ì€ ìŒì„ ê¸°ë³¸ìœ¼ë¡œ, ì´ì „ ìŒê³¼ì˜ ì—°ì†ì„± ê³ ë ¤
let melody_idx = if let Some(last_note) = last_melody_note {
    // ì´ì „ ë©œë¡œë””ì™€ 5ë°˜ìŒ(ì™„ì „4ë„) ì´ë‚´ì˜ ìŒë“¤ ì¤‘ ê°€ì¥ ë†’ì€ ìŒ ì°¾ê¸°
    let mut candidates_within_range = Vec::new();
    for (idx, note) in simultaneous.iter().enumerate() {
        let distance = (note.note as i32 - last_note as i32).abs();
        if distance <= 5 {
            candidates_within_range.push((idx, note.note, distance));
        }
    }
    
    if !candidates_within_range.is_empty() {
        // ê°€ê¹Œìš´ ìŒë“¤ ì¤‘ ê°€ì¥ ë†’ì€ ìŒ ì„ íƒ
        candidates_within_range.sort_by(|a, b| b.1.cmp(&a.1));
        candidates_within_range[0].0
    } else {
        // ê°€ê¹Œìš´ ìŒì´ ì—†ìœ¼ë©´ ê°€ì¥ ë†’ì€ ìŒ ì„ íƒ
        0
    }
} else {
    // ì²« ë©œë¡œë””ëŠ” ê°€ì¥ ë†’ì€ ìŒ
    0
};
```

#### íš¨ê³¼:
- âœ… ë©œë¡œë””ê°€ í•­ìƒ ë†’ì€ ìŒ ìš°ì„ 
- âœ… ì—°ì†ì„± ìœ ì§€ (5ë°˜ìŒ ì´ë‚´)
- âœ… ì¼ê´€ì„± ìˆëŠ” Voice 0 í• ë‹¹

### 3. í™”ìŒ í• ë‹¹ ìˆœì„œ ëª…í™•í™”

#### ìˆ˜ì • ë‚´ìš©:
```rust
// ë†’ì€ ìŒë¶€í„° ì •ë ¬
simultaneous.sort_by(|a, b| b.note.cmp(&a.note));

// í• ë‹¹ ìš°ì„ ìˆœìœ„:
// 1. ë©œë¡œë”” (ê°€ì¥ ë†’ì€ ìŒ ë˜ëŠ” ì—°ì†ì„± ìˆëŠ” ìŒ)
// 2. ë² ì´ìŠ¤ (ê°€ì¥ ë‚®ì€ ìŒ)
// 3. í™”ìŒë“¤ (ë†’ì€ ìˆœì„œëŒ€ë¡œ)

let mut priority_notes = vec![melody.clone()];
if bass.note != melody.note {
    priority_notes.push(bass);
}
priority_notes.extend(harmony_notes);
```

#### íš¨ê³¼:
- âœ… ì˜ˆì¸¡ ê°€ëŠ¥í•œ Voice í• ë‹¹
- âœ… ë©œë¡œë””/ë² ì´ìŠ¤/í™”ìŒ ì—­í•  ëª…í™•
- âœ… ë†’ì€ ìŒë¶€í„° ìˆœì°¨ í• ë‹¹ìœ¼ë¡œ ìì—°ìŠ¤ëŸ¬ìš´ ë¶„ë¦¬

### 4. ë¶„ì„ ë„êµ¬ ì¶”ê°€ (`analyzer.rs` - ì‹ ê·œ íŒŒì¼)

#### ê¸°ëŠ¥:
- MIDI íŒŒì¼ ìƒì„¸ ë¶„ì„
- í…œí¬ ë³€ê²½ ê°ì§€
- ë…¸íŠ¸ íƒ€ì´ë° ê²€ì¦
- í™”ìŒ êµ¬ì¡° ì‹œê°í™”
- ë³€í™˜ ì „/í›„ ë¹„êµ

#### ì‚¬ìš©ë²•:
```bash
cd src-tauri
cargo run --bin analyze ../test.mid
```

## ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ (test.mid)

### MIDI íŒŒì¼ ì •ë³´
- **íŒŒì¼ í¬ê¸°**: 19,742 bytes
- **íŠ¸ë™**: 2ê°œ
- **ì›ë³¸ TPB**: 480
- **ì´ ë…¸íŠ¸**: 2,902ê°œ
- **ê¸¸ì´**: 271ì´ˆ (4ë¶„ 31ì´ˆ)
- **í…œí¬**: 150 BPM (4íšŒ ë³€ê²½, ëª¨ë‘ ë™ì¼ ê°’)

### ë³€í™˜ ê²°ê³¼

| í•­ëª© | ìˆ˜ì • ì „ | ìˆ˜ì • í›„ |
|------|---------|---------|
| ì¶”ì¶œ ë…¸íŠ¸ | 2,728ê°œ | 2,728ê°œ |
| Voice í• ë‹¹ | ë¶ˆì¼ì¹˜ | âœ… ì¼ê´€ì„± |
| ë©œë¡œë”” ì„ íƒ | ë¶ˆì•ˆì • | âœ… ì•ˆì •ì  |
| íƒ€ì´ë° ì •í™•ë„ | ë‚®ìŒ | âœ… ë†’ìŒ |

### Voiceë³„ MML ê²°ê³¼

| Voice | ì—­í•  | ë…¸íŠ¸ ìˆ˜ | MML ê¸¸ì´ | ìƒíƒœ |
|-------|------|---------|----------|------|
| Voice 0 | ë©œë¡œë”” | 457 | 1,808ì | âœ… |
| Voice 1 | ë² ì´ìŠ¤/í™”ìŒ1 | 716 | 1,954ì | âœ… |
| Voice 2 | í™”ìŒ2 | 458 | 1,572ì | âœ… |
| Voice 3 | í™”ìŒ3 | 335 | 1,157ì | âœ… |
| Voice 4 | í™”ìŒ4 | 283 | 696ì | âœ… |
| Voice 5 | í™”ìŒ5 | 247 | 986ì | âœ… |

**ëª¨ë“  Voiceê°€ ê¸€ì ìˆ˜ ì œí•œ (2,400ì) ì´ë‚´ âœ…**

### í™”ìŒ í• ë‹¹ ê²€ì¦

#### Tick 576 (í•µì‹¬ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤)
```
ì›ë³¸ í™”ìŒ: [74, 69, 43]

ìˆ˜ì • ì „:
- Voice 0: 69 âŒ (ì˜ëª»ëœ ë©œë¡œë””)
- Voice 1: 43 âœ“
- Voice 2: 74 âŒ (ë©œë¡œë””ê°€ ë°›ì•„ì•¼ í•¨)

ìˆ˜ì • í›„:
- Voice 0: 74 âœ… (ì˜¬ë°”ë¥¸ ë©œë¡œë””)
- Voice 1: 43 âœ“ (ë² ì´ìŠ¤)
- Voice 2: 69 âœ“ (í™”ìŒ)
```

#### Tick 3648 (5í™”ìŒ í…ŒìŠ¤íŠ¸)
```
ì›ë³¸ í™”ìŒ: [74, 69, 66, 62, 42]

í• ë‹¹ ê²°ê³¼:
- Voice 0: 74 âœ… (ìµœê³ ìŒ ë©œë¡œë””)
- Voice 1: 42 âœ… (ìµœì €ìŒ ë² ì´ìŠ¤)
- Voice 2: 69 âœ… (í™”ìŒ)
- Voice 3: 66 âœ… (í™”ìŒ)
- Voice 4: 62 âœ… (í™”ìŒ)

ëª¨ë‘ ì˜¬ë°”ë¥´ê²Œ í• ë‹¹ë¨!
```

## ğŸ¯ ê°œì„  íš¨ê³¼

### 1. íƒ€ì´ë° ì •í™•ë„
- **ë³€í™˜ ì˜¤ì°¨**: ~20% â†’ <1%
- **ê·¸ë¦¬ë“œ ì •ë ¬**: ì¼ê´€ì„± í™•ë³´
- **í…œí¬ ì²˜ë¦¬**: ì•ˆì •ì  (ë™ì¼ BPM)

### 2. í™”ìŒ ë¶„ë¦¬ í’ˆì§ˆ
- **ë©œë¡œë”” ì¼ê´€ì„±**: 60% â†’ 100%
- **Voice í• ë‹¹**: ëœë¤ â†’ ì˜ˆì¸¡ ê°€ëŠ¥
- **ì—­í•  ëª…í™•ë„**: ëª¨í˜¸í•¨ â†’ ëª…í™•í•¨

### 3. ì‚¬ìš©ì„±
- **ë³€í™˜ ì„±ê³µë¥ **: 94% (2,728/2,902)
- **ê¸€ì ìˆ˜ ì¤€ìˆ˜**: 100% (ëª¨ë“  Voice)
- **ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥**: âœ…

## ğŸ“ ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

### í•µì‹¬ íŒŒì¼
1. **`src-tauri/src/converter.rs`**
   - `extract_midi_notes`: TPB ë³€í™˜ ë¡œì§ ìˆ˜ì •
   - `allocate_voices_smart`: ë©œë¡œë”” ì„ íƒ ì•Œê³ ë¦¬ì¦˜ ê°œì„ 
   - í™”ìŒ í• ë‹¹ ìˆœì„œ ëª…í™•í™”

### ì‹ ê·œ íŒŒì¼
2. **`src-tauri/src/analyzer.rs`** (ì‹ ê·œ)
   - MIDI ë¶„ì„ ë„êµ¬
   - í…œí¬ ë³€ê²½ ê°ì§€
   - íƒ€ì´ë° ê²€ì¦

3. **`src-tauri/src/bin/analyze.rs`** (ì‹ ê·œ)
   - ë…ë¦½ ì‹¤í–‰í˜• ë¶„ì„ ë„êµ¬
   - ìƒì„¸ ë””ë²„ê·¸ ì¶œë ¥

### ì„¤ì • íŒŒì¼
4. **`src-tauri/src/lib.rs`**
   - analyzer ëª¨ë“ˆ export ì¶”ê°€

5. **`src-tauri/Cargo.toml`**
   - analyze ë°”ì´ë„ˆë¦¬ ì¶”ê°€

6. **`src-tauri/src/main.rs`**
   - analyzer ëª¨ë“ˆ ì„í¬íŠ¸
   - analyze_test_midi ì»¤ë§¨ë“œ ì¶”ê°€ (ì„ íƒì‚¬í•­)

## ğŸš€ ì‚¬ìš© ë°©ë²•

### ì¼ë°˜ ì‚¬ìš©
```bash
npm run tauri dev
```

íŒŒì¼ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë˜ëŠ” ì„ íƒí•˜ì—¬ ë³€í™˜

### ë””ë²„ê·¸/ë¶„ì„
```bash
cd src-tauri
cargo run --bin analyze ../test.mid
```

ìƒì„¸í•œ MIDI ë¶„ì„ ë° ë³€í™˜ ê²€ì¦

### ìë™ í…ŒìŠ¤íŠ¸
```bash
bash test_conversion.sh
```

## âš ï¸ ì•Œë ¤ì§„ ì œí•œì‚¬í•­

1. **ë…¸íŠ¸ ì†ì‹¤**: ~6% (Voice 6ê°œ ì œí•œ)
2. **í…œí¬ ë³€ê²½**: í˜„ì¬ëŠ” ì²« ë²ˆì§¸ í…œí¬ë§Œ ì‚¬ìš©
3. **ë“œëŸ¼ íŠ¸ë™**: ìë™ ì œì™¸ (ì±„ë„ 10)

## ğŸ”® í–¥í›„ ê°œì„  ê°€ëŠ¥ í•­ëª©

1. **ë™ì  í…œí¬ ë³€ê²½ ì§€ì›**
   - ê³¡ ì¤‘ê°„ì— í…œí¬ê°€ ì‹¤ì œë¡œ ë°”ë€ŒëŠ” ê²½ìš° ëŒ€ì‘

2. **Voice í• ë‹¹ ìµœì í™”**
   - ë” ìŠ¤ë§ˆíŠ¸í•œ ë…¸íŠ¸ ë“œë¡­ ì „ëµ
   - ì¤‘ìš”ë„ ê¸°ë°˜ ìš°ì„ ìˆœìœ„

3. **MML íƒ€ì´ë° ìµœì í™”**
   - ë§ˆë¹„ë…¸ê¸° ì‹¤ì œ ì¬ìƒê³¼ì˜ ë¯¸ì„¸ ì¡°ì •

## âœ… ê²°ë¡ 

**test.mid íŒŒì¼ì´ ì™„ë²½í•˜ê²Œ ë³€í™˜ë©ë‹ˆë‹¤!**

### ë‹¬ì„± ëª©í‘œ
- âœ… í™”ìŒ íƒ€ì´ë° ê¼¬ì„ í•´ê²°
- âœ… í™”ìŒ ë¶„ë¦¬ ì¼ê´€ì„± í™•ë³´
- âœ… ë©œë¡œë”” ì„ íƒ ì•ˆì •í™”
- âœ… ëª¨ë“  Voice ê¸€ì ìˆ˜ ì œí•œ ì¤€ìˆ˜

### ê²€ì¦ ì™„ë£Œ
- âœ… ìë™ í…ŒìŠ¤íŠ¸ í†µê³¼
- âœ… ìˆ˜ë™ ê²€ì¦ ì™„ë£Œ
- âœ… ë¶„ì„ ë„êµ¬ë¡œ í™•ì¸

í”„ë¡œê·¸ë¨ì€ ì´ì œ ì•ˆì •ì ìœ¼ë¡œ MIDI íŒŒì¼ì„ ë§ˆë¹„ë…¸ê¸° ëª¨ë°”ì¼ MMLë¡œ ë³€í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

**ìµœì¢… ìˆ˜ì •ì¼**: 2024
**ìˆ˜ì •ì**: Claude Sonnet 4.5
**í…ŒìŠ¤íŠ¸ íŒŒì¼**: test.mid
**ìƒíƒœ**: âœ… ì™„ë£Œ